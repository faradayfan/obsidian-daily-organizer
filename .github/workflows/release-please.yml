name: Release Please

on:
    push:
        branches:
            - main
            - master

permissions:
    contents: write
    pull-requests: write

jobs:
    release-please:
        runs-on: ubuntu-latest
        steps:
            - uses: googleapis/release-please-action@v4
              id: release
              with:
                  release-type: node

            # Build and upload assets only if a release was created
            - name: Checkout code
              if: ${{ steps.release.outputs.release_created }}
              uses: actions/checkout@v5

            - name: Setup Node.js
              if: ${{ steps.release.outputs.release_created }}
              uses: actions/setup-node@v3
              with:
                  node-version: "18"

            - name: Install dependencies
              if: ${{ steps.release.outputs.release_created }}
              run: npm ci

            - name: Run linter
              if: ${{ steps.release.outputs.release_created }}
              run: npm run lint

            - name: Run tests
              if: ${{ steps.release.outputs.release_created }}
              run: npm test

            - name: Build plugin
              if: ${{ steps.release.outputs.release_created }}
              run: npm run build

            - name: Upload main.js
              if: ${{ steps.release.outputs.release_created }}
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.release.outputs.upload_url }}
                  asset_path: ./main.js
                  asset_name: main.js
                  asset_content_type: application/javascript

            - name: Upload manifest.json
              if: ${{ steps.release.outputs.release_created }}
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.release.outputs.upload_url }}
                  asset_path: ./manifest.json
                  asset_name: manifest.json
                  asset_content_type: application/json

            - name: Upload styles.css
              if: ${{ steps.release.outputs.release_created }}
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.release.outputs.upload_url }}
                  asset_path: ./styles.css
                  asset_name: styles.css
                  asset_content_type: text/css
